---
title: Secure communication using AWS VPC Lattice
description: Route traffic to subgraphs on your AWS VPC
noIndex: true
---

> Cloud Dedicated is currently in [preview](/resources/product-launch-stages#preview). Your questions and feedback are highly valued—don't hesitate to [get in touch](mailto:cloud@apollographql.com).

To send traffic to your subgraphs running in an AWS VPC without exposing them to the internet, Apollo GraphOS Cloud leverages [AWS VPC Lattice](https://aws.amazon.com/vpc/lattice/). With Lattice, you can define services and share them with the Apollo AWS organization. Apollo GraphOS Cloud can then send traffic directly to your subgraphs without using VPC peering.

```mermaid
flowchart LR;
  clients(Clients);
  subgraph "Apollo Cloud";
    router(["GraphOS <br/> Dedicated"]);
  end;
  resourceshare["AWS RAM <br/> Resource <br/> Share"]
  subgraph "AWS Virtual Private Cloud"
    lattice[AWS VPC <br/> Lattice <br/> Service]
    service1[Service 1];
    service2[Service 2];
    service3[Service 3];
  end;

  router --> resourceshare
  resourceshare --> lattice
  lattice --> service1 & service2 & service3;

  clients -->|Requests| router;
```

<blockquote>

⚠️ **Note**:
- You can only use Lattice for subgraphs in the **same AWS region as your Cloud Router**. If you need to run subgraphs in different AWS regions, or you run your workloads in a region not yet supported by Apollo GraphOS Cloud, please [let us know](mailto:cloud@apollographql.com).
- Using AWS VPC Lattice incurs costs outside of your Apollo GraphOS Cloud spend. Refer to the [Lattice pricing page](https://aws.amazon.com/vpc/lattice/pricing/) to learn more.

</blockquote>

## Create and share an AWS VPC Lattice service

To allow Apollo GraphOS Cloud to send traffic to your private subgraphs, you must:
1. Create one or more AWS VPC Lattice target groups
2. Create one or more AWS VPC Lattice services.
3. Share the service(s) with the Apollo AWS Organization.
4. Provide the service(s) routing information in your Apollo Organization configuration page.

> The AWS Console interface may differ slightly from the screenshots in this guide.

### Step 1. Create AWS VPC Lattice target groups

A Lattice **target group** is a collection of targets, or compute resources, that run your application or service. You need to set these up so your Lattice services ... Check out the [AWS documentation](https://docs.aws.amazon.com/vpc-lattice/latest/ug/target-groups.html) to learn more.

1. In the AWS Console for your region of choice, go to the VPC service page:
- [US East (N. Virginia) — `us-east-1`](https://us-east-1.console.aws.amazon.com/vpc/home?region=us-east-1)
- [Europe (Ireland) — `eu-west-1`](https://eu-west-1.console.aws.amazon.com/vpc/home?region=eu-west-1)

2. In the menu on the left, scroll down and open **Target groups** in the **VPC Lattice** section.

<img class="screenshot" alt="AWS VPC service page left menu" src="../../../img/cloud-dedicated/vpc-lattice-menu.jpg" />

3. Click **Create target group** on the top right.

<img class="screenshot" alt="AWS VPC service page" src="../../../img/cloud-dedicated/create-target-group.jpg" />

4. In the **Basic configuration** section, set the properties that match your subgraph resources.

<img class="screenshot" alt="AWS VPC service page" src="../../../img/cloud-dedicated/target-group-configuration.jpg" />

5. (Optional) If you are using a target type with health checks, make sure you configure your health checks correctly or Lattice will not be able to send traffic to your subgraphs.

<img class="screenshot" alt="AWS VPC service page" src="../../../img/cloud-dedicated/target-group-health-checks.jpg" />

6. Register the targets based on your chosen target type.

<img class="screenshot" alt="AWS VPC service page" src="../../../img/cloud-dedicated/register-targets.jpg" />

7. Review your targets to make sure all information is correct.

<img class="screenshot" alt="AWS VPC service page" src="../../../img/cloud-dedicated/review-targets.jpg" />

8. Click **Create target group** in the bottom right corner of the page.

<img class="screenshot" alt="AWS VPC service page" src="../../../img/cloud-dedicated/create-target-group-final.jpg" />

Congratulations! You created a AWS VPC Lattice target group. Repeat this process for each different resource that you want to share with Apollo GraphOS Cloud.

### Step 2. Create an AWS VPC Lattice service

1. In the AWS Console for your region, go to the VPC service page:
- [US East (N. Virginia) — `us-east-1`](https://us-east-1.console.aws.amazon.com/vpc/home?region=us-east-1)
- [Europe (Ireland) — `eu-west-1`](https://eu-west-1.console.aws.amazon.com/vpc/home?region=eu-west-1)
2. In the menu on the left, scroll down and open **Services** in the **VPC Lattice** section.

<img class="screenshot" alt="AWS VPC service page left menu" src="../../../img/cloud-dedicated/vpc-lattice-menu.jpg" />

3. Click **Create service** in the top right.

<img class="screenshot" alt="AWS VPC service page" src="../../../img/cloud-dedicated/create-service.jpg" />

4. In the **Identifiers** section, give the name, description, and tags of your choice for the service.

<img class="screenshot" alt="AWS VPC service page" src="../../../img/cloud-dedicated/service-identifiers.jpg" />

5. In the **Custom domain configuration** section, leave the **Specify a custom domain configuration** checkbox **unselected**.

<img class="screenshot" alt="AWS VPC service page" src="../../../img/cloud-dedicated/custom-domain.jpg" />

6. In the **Service access** section, select the AWS IAM authentication type, and paste the following auth policy. This policy ensures that only the AWS Organization for Apollo GraphOS Cloud can send traffic to your subgraphs.

```
{
	"Version": "2012-10-17",
	"Statement": [
    	{
        	"Effect": "Allow",
        	"Principal": "*",
        	"Action": "vpc-lattice-svcs:Invoke",
        	"Resource": "*",
        	"Condition": {
            	"ForAnyValue:StringLike": {
                	"aws:PrincipalOrgPaths": "o-9vaxczew6u/*/ou-leyb-l9pccq2t/ou-leyb-fvqz35yo/*"
            	}
        	}
    	}
	]
}
```

<img class="screenshot" alt="AWS VPC service page" src="../../../img/cloud-dedicated/service-access-policy.jpg" />

7. (Optional) For extra security, you can audit all the traffic coming to your subgraph by enabling access logs in the **Monitoring** section.

8. Once you have configured the service, you can click **Next** on the bottom right of the page.

<img class="screenshot" alt="AWS VPC service page" src="../../../img/cloud-dedicated/service-monitoring.jpg" />

9. Define routing information to your target groups. Set the protocol to **HTTPS** and the port to **443**.

> For security reasons, we require you to use HTTPS for your listener. This enforces encryption in transit of the traffic between your GraphOS Cloud Router and your Lattice listener.

<img class="screenshot" alt="AWS VPC service page" src="../../../img/cloud-dedicated/http-listener.jpg" />

10. If you have multiple target groups, make sure you add a rule for each subgraph.

<img class="screenshot" alt="AWS VPC service page" src="../../../img/cloud-dedicated/service-rules.jpg" />

11. Click **Next** at the bottom right of the page once you are done configuring your listener.

<img class="screenshot" alt="AWS VPC service page" src="../../../img/cloud-dedicated/listener-complete.jpg" />

12. Do _NOT_ pick a VPC Lattice service network. Your subgraphs will integrate with a service network managed by Apollo. Instead, click the **Next** button at the bottom right of the page.

<img class="screenshot" alt="AWS VPC service page" src="../../../img/cloud-dedicated/service-network.jpg" />

13. Make sure the information you've entered is correct and click **Create VPC Lattice service** at the bottom right of the page.

<img class="screenshot" alt="AWS VPC service page" src="../../../img/cloud-dedicated/create-service-final.jpg" />

Congratulations! You have now created a Lattice service for your subgraphs.

### Step 3. Share the AWS VPC Lattice service with Apollo GraphOS Cloud

1. In the AWS Console for your region of choice, go to the Resource Access Manager service page:
- [US East (N. Virginia) — us-east-1](https://us-east-1.console.aws.amazon.com/ram/home?region=us-east-1)
- [Europe (Ireland) — eu-west-1](https://eu-west-1.console.aws.amazon.com/ram/home?region=eu-west-1)

2. In the menu on the left, click **Resource shares** in the **Shared by me** section.

<img class="screenshot" alt="AWS VPC service page left menu" src="../../../img/cloud-dedicated/vpc-lattice-menu.jpg" />

3. Click **Create resource share** in the top right corner.

<img class="screenshot" alt="AWS VPC shared resources page" src="../../../img/cloud-dedicated/create-resource-share.jpg" />

4. In the **Resource share name** section, enter a name for your resource share.

<img class="screenshot" alt="AWS VPC shared resources page" src="../../../img/cloud-dedicated/resource-share-name.jpg" />

5. In the **Resources section**, select the resource type **VPC Lattice Services**.

<img class="screenshot" alt="AWS VPC shared resources page" src="../../../img/cloud-dedicated/resource-share-name.jpg" />

6. Select all the Lattice services that contain your subgraphs.

<img class="screenshot" alt="AWS VPC shared resources page" src="../../../img/cloud-dedicated/resource-selection.jpg" />

7. (Optional) Set tags for your resource share.

<img class="screenshot" alt="AWS VPC shared resources page" src="../../../img/cloud-dedicated/resource-tags.jpg" />

8. Click the **Next** button in the bottom right corner of the page.

<img class="screenshot" alt="AWS VPC shared resources page" src="../../../img/cloud-dedicated/resource-tags-next.jpg" />

9. Verify that the managed permissions give access to associate the Lattice services with a service network (`vpc-lattice:CreateServiceNetworkServiceAssociation and vpc-lattice:GetService`). Then click the **Next** button in the bottom right of the page.

<img class="screenshot" alt="AWS VPC shared resources page" src="../../../img/cloud-dedicated/managed-permissions.jpg" />

10. In the **Principals** section, select **Allow sharing with anyone**, with a principal type of **AWS account**, enter the following value for the account ID: `282421723282`, then click the **Add** button.

<img class="screenshot" alt="AWS VPC shared resources page" src="../../../img/cloud-dedicated/resource-principal.jpg" />

11. Confirm that `282421723282` is the only selected principal for this resource share, then click the **Next** button on the bottom right corner.

<img class="screenshot" alt="AWS VPC shared resources page" src="../../../img/cloud-dedicated/resource-principal-confirmation.jpg" />

12. Confirm that all the information is correct, then click **Create resource share** in the bottom right of the page.

<img class="screenshot" alt="AWS VPC shared resources page" src="../../../img/cloud-dedicated/create-resource-share-final.jpg" />

Congratulations! You have now shared your Lattice services with Apollo GraphOS Cloud.

The last step now is to associate your resource share with the Apollo Organization account.

<blockquote>

⚠️ **Note**:
- You only have 12 hours to associate your resource share, otherwise AWS Resource Access Manager will fail to process the invitation and you will have to restart this step.
- For security purposes, we recommend you to continue to the next step immediately after creating the resource share. If you see that the resource share was **Accepted** or **Failed** in the AWS console and you did not follow step 4 of this guide, follow the steps to [remove access to private subgraphs](#remove-access-to-private-subgraphs) and restart this step.

</blockquote>

### Step 4. Associate your resource share with your Apollo Organization

1. In the AWS Console for your region of choice, go to the Resource Access Manager service page:
- [US East (N. Virginia) — us-east-1](https://us-east-1.console.aws.amazon.com/ram/home?region=us-east-1)
- [Europe (Ireland) — eu-west-1](https://eu-west-1.console.aws.amazon.com/ram/home?region=eu-west-1)
2. In the menu on the left, click **Resource shares** in the **Shared by me** section.

<img class="screenshot" alt="AWS VPC service page left menu" src="../../../img/cloud-dedicated/shared-by-me.jpg" />

3. Click the resource share you created in the previous step.

<img class="screenshot" alt="AWS VPC resource share page" src="../../../img/cloud-dedicated/select-resource-share.jpg" />

4. Copy the **ARN** for the resource share.

<img class="screenshot" alt="AWS VPC resource share page" src="../../../img/cloud-dedicated/resource-share-summary.jpg" />

5. Go to the [GraphOS Studio](https://studio.apollographql.com?referrer=docs-content).
6. Click the **Settings** tab at the top of the screen.

## Removing access to private subgraphs

Keep in mind that any existing supergraph that sends traffic to your private subgraphs will stop working once you remove access for Apollo GraphOS Cloud.

### Remove resource shares

1. In the AWS Console for your region of choice, go to the Resource Access Manager service page:
- [US East (N. Virginia) — us-east-1](https://us-east-1.console.aws.amazon.com/ram/home?region=us-east-1)
- [Europe (Ireland) — eu-west-1](https://eu-west-1.console.aws.amazon.com/ram/home?region=eu-west-1)
2. In the menu on the left, click **Resource shares** in the **Shared by me** section.

<img class="screenshot" alt="AWS VPC service page left menu" src="../../../img/cloud-dedicated/vpc-lattice-menu.jpg" />

3. Select the resource share(s) associated with Apollo GraphOS Cloud and click the **Delete** button in the top right corner.

<img class="screenshot" alt="AWS VPC resource share page" src="../../../img/cloud-dedicated/create-resource-share.jpg" />

4. Click **Delete** in the popup modal.

<img class="screenshot" alt="AWS VPC resource share page" src="../../../img/cloud-dedicated/delete-resource-share.jpg" />

### Remove service network associations

1. In the AWS Console for your region of choice, go to the VPC service page:
- [US East (N. Virginia) — us-east-1](https://us-east-1.console.aws.amazon.com/ram/home?region=us-east-1)
- [Europe (Ireland) — eu-west-1](https://eu-west-1.console.aws.amazon.com/ram/home?region=eu-west-1)
2. In the menu on the left, scroll down and open **Services** in the **VPC Lattice** section.

<img class="screenshot" alt="AWS VPC service page left menu" src="../../../img/cloud-dedicated/vpc-lattice-menu.jpg" />

3. Click the name of the Lattice service you want to disconnect.

<img class="screenshot" alt="AWS VPC service page" src="../../../img/cloud-dedicated/select-lattice-service.jpg" />

4. In the **Service network associations**, select the **graphos-cloud** service name.

<img class="screenshot" alt="AWS VPC service page" src="../../../img/cloud-dedicated/graphos-service.jpg" />

5. Click the **Actions** button in the top right of that section, and click **Delete network associations**.

<img class="screenshot" alt="AWS VPC service page" src="../../../img/cloud-dedicated/delete-network-associations.jpg" />

6. Follow the confirmation instructions and click **Delete**.

<img class="screenshot" alt="AWS VPC service page" src="../../../img/cloud-dedicated/delete-network-associations-final.jpg" />

Deleting the network association can take a few seconds. Once the network association is deleted, Apollo GraphOS Cloud cannot contact your subgraphs anymore.

## Frequently asked questions

#### I've added a new service to my resource share, but it doesn't appear in my private subgraphs. How can I fix this?

Apollo GraphOS Cloud does not automatically scan your resource shares for new Lattice services. If you add a service, you can manually trigger a scan by going to your Apollo Organization settings page and clicking on the **Rescan subgraphs** button.

#### I want to use AWS VPC Lattice within my own organization. Can I still use Lattice for private subgraphs?

Yes. Apollo GraphOS Cloud will associate your Lattice services with its own service network, and you can associate a Lattice service with multiple service networks. You can also create multiple Lattice target groups or Lattice services for the same load balancer, IP addresses, Lambda functions, or other resources supported by Lattice target groups.

#### How does Apollo GraphOS Cloud prevent other users from accessing my private subgraphs?

When you associate a resource share for the first time, Apollo GraphOS Cloud will scan the Lattice services contained in the resource share to retrieve their ARNs and domain names.

When you add a private subgraph to one of your supergraphs, GraphOS Cloud will check that the domain for that subgraph matches one of the Lattice services you have associated with your Apollo Organization.

As a second line of defense, supergraphs use AWS IAM permissions and SigV4 to only allow traffic to the subgraphs in the same Apollo organization.
